#!/bin/bash

datediff=''
date=''
commitmsg=''

edit(){
  setEditDate
  read Y M D h m s <<< ${date//[-: ]/ }
  [ ! -d "$gitary_data/$Y/$M" ] && mkdir -p "$gitary_data/$Y/$M"
  [ -z "$commitmsg" ] && $EDITOR "$gitary_data/$Y/$M/$D" || echo "$commitmsg" >> "$gitary_data/$Y/$M/$D"
  commit
}

commit (){
  cd "$gitary_data"
  git add -A "."
  [ -n "$(git status --porcelain)" ] && git commit -m "Auto commit 
 $(git status --porcelain)"
}

search (){
  cd "$gitary_data"
  needle="$@"
  if [ -n "$needle" ]; then
    echo "          Term                 "
    echo "-------------------------------"
    found=$(grep --color --exclude-dir=.git -Re "$needle" . | sed 's/.\///' | sed 's/:/ => /')
    echo "$found"
  fi
}

setEditDate (){
  if [ -z "$datediff" ]; then
    date=$(date +'%Y-%m-%d %H:%M:%S')
  else
    date=$(date -d "$datediff" +'%Y-%m-%d %H:%M:%S')
  fi
}

commands (){
  case "$1" in
    "edit")
      edit
      ;;
    "search")
      shift
      search $@
      ;;
    *)
      echo "Try --help, because $1 didn't work"
      ;;
  esac
}

help (){
  echo "
edit - edit today
search - simple grep for term
-d to change the edit date
-h for this help file"
  exit
}

[ -z "$GITARY_DATA" ] && gitary_data="$HOME/.gitary" || gitary_data=$GITARY_DATA

if [ ! -d "$gitary_data/.git" ]; then
  echo "$gitary_data is not a git repo, please run \`git init\` inside"
  echo "Or set GITARY_DATA to your git directory"
  exit
fi

ARGS=$(getopt -o d:hm:t: -l "date:,help,message:" -n "gitary" -- "$@");
eval set -- "$ARGS";
while true; do
  case "$1" in
    -d|--date)
      shift;
      if [ -n "$1" ]; then
        datediff="$1";
        shift;
      fi 
      ;;
    -h|--help)
      shift;
      help
      ;;
    -m|--message)
      shift;
      commitmsg=$1
      shift;
      ;;
    --)
      shift;
      commands "$@"
      break;
      ;;
  esac
done
