#!/bin/bash

datediff=""
date=""

edit(){
  setEditDate
  read Y M D h m s <<< ${date//[-: ]/ }
  [ ! -d "$gitary_data/$Y/$M" ] && mkdir -p "$gitary_data/$Y/$M"
  [ -z "$1" ] && $EDITOR "$gitary_data/$Y/$M/$D" || echo "$1" >> "$gitary_data/$Y/$M/$D"
  commit
}

commit (){
  cd "$gitary_data"
  git add -A "."
  git commit -m "Auto commit 
 $(git status --porcelain)"
}

setEditDate (){
  if [ -z "$datediff" ]; then
    date=$(date +'%Y-%m-%d %H:%M:%S')
  else
    date=$(date $datediff +'%Y-%m-%d %H:%M:%S')
  fi
}

[ -z "$GITARY_DATA" ] && gitary_data="$HOME/.gitary" || gitary_data=$GITARY_DATA

if [ ! -d "$gitary_data/.git" ]; then
  echo "$gitary_data is not a git repo!"
  echo 'Please run `git init` inside '$gitary_data
  exit
fi

ARGS=$(getopt -o d:ehm: -l "date:,edit,help,message:" -n "gitary" -- "$@");
eval set -- "$ARGS";
while true; do
  case "$1" in
    -d|--date)
      shift;
      if [ -n "$1" ]; then
        datediff="-d $1";
        shift;
      fi 
      ;;
    -e|--edit)
      shift;
      edit
      exit
      ;;
    -h|--help)
      shift;
      echo "print help";
      ;;
    -m|--message)
      shift;
      edit "$1"
      shift;
      ;;
    --)
      shift;
      break;
      ;;
  esac
done
