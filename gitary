#!/bin/bash

DATEDIFF=""
DATE=""

edit(){
  setEditDate
  read Y M D h m s <<< ${DATE//[-: ]/ }
  [ ! -d "$GITDIR/$Y/$M" ] && mkdir -p "$GITDIR/$Y/$M"
  [ -z "$1" ] && $EDITOR "$GITDIR/$Y/$M/$D" || echo "$1" >> "$GITDIR/$Y/$M/$D"
  commit
}

commit (){
  cd "$GITDIR"
  git add -A "."
  git commit -m "Auto commit 
 $(git status --porcelain)"
}

setEditDate (){
  if [ -z "$DATEDIFF" ]; then
    DATE=$(date +'%Y-%m-%d %H:%M:%S')
  else
    DATE=$(date $DATEDIFF +'%Y-%m-%d %H:%M:%S')
  fi
}

if [ -f "$HOME/.gitary" ]; then
  source "$HOME/.gitary"
else
  echo "Coulnd't find a config file"
  exit
fi

if [ ! -d "$GITDIR/.git" ]; then
  echo "Not a git repo!"
  exit
fi

ARGS=$(getopt -o d:ehm: -l "date:,edit,help,message:" -n "gitary" -- "$@");
eval set -- "$ARGS";
while true; do
  case "$1" in
    -d|--date)
      shift;
      if [ -n "$1" ]; then
        DATEDIFF="-d $1";
        shift;
      fi 
      ;;
    -e|--edit)
      shift;
      edit
      exit
      ;;
    -h|--help)
      shift;
      echo "print help";
      ;;
    -m|--message)
      shift;
      edit "$1"
      shift;
      ;;
    --)
      shift;
      break;
      ;;
  esac
done
